{%- from "dovecot/map.jinja" import server with context %}

auth_debug = {% if server.debug %}yes{% else %}no{% endif %}
auth_verbose = {% if server.verbose %}yes{% else %}no{% endif %}

{%- if server.ssl.enabled %}

ssl_cert = < /etc/dovecot/ssl/ssl_cert.crt
ssl_key = < /etc/dovecot/ssl/ssl_key.key
ssl_protocols = !SSLv2 !SSLv3
ssl = required
disable_plaintext_auth = yes

{%- endif %}

first_valid_gid = 20
first_valid_uid = 20

listen = * [::]

log_timestamp = "%Y-%m-%d %H:%M:%S "

mail_access_groups = postfix
mail_privileged_group = postfix
mail_location = maildir:{{ server.mailbox_base }}/%d/%u
mail_max_userip_connections = 99

{%- if server.nfs %}
# NFS support
mail_nfs_index = yes
mail_nfs_storage = yes
mail_fsync=always
mmap_disable = yes
{%- endif %}

namespace inbox {
  inbox = yes

  mailbox Drafts {
    auto = subscribe
    special_use = \Drafts
  }

  mailbox Junk {
    auto = subscribe
    special_use = \Junk
  }

  mailbox Trash {
    auto = subscribe
    special_use = \Trash
  }

  mailbox Sent {
    auto = subscribe
    special_use = \Sent
  }

  mailbox "Sent Messages" {
    special_use = \Sent
  }

  mailbox Archive {
    auto = subscribe
    special_use = \Archive
  }
}

passdb {
  args = /etc/dovecot/dovecot-sql.conf
  driver = sql
}

protocols = imap pop3 {% if server.service.lmtp.enabled %}lmtp{% endif %} {% if server.service.lmtp.enabled %}sieve{% endif %}

service auth {
  unix_listener /var/spool/postfix/private/auth {
    mode = 0660
    user = postfix
    group = postfix
  }
  user = dovecot
}

service imap-login {
  chroot = login
  user = dovecot
  vsz_limit = 64M
}

service pop3-login {
  chroot = login
  user = dovecot
  vsz_limit = 64M
}

{%- if server.service.lmtp.enabled %}

service lmtp {
  user = {{ server.user.name }}
  process_min_avail = {{ server.service.lmtp.process_min_avail }}
  unix_listener /var/spool/postfix/private/dovecot-lmtp {
    mode = 0600
    user = postfix
    group = postfix
  }
}

protocol lmtp {
  postmaster_address = {{ server.admin }}
  mail_plugins = quota sieve
}

{%- endif %}

{%- if server.service.sieve.enabled %}

service managesieve-login {
  inet_listener sieve {
    port = 4190
  }
}

service managesieve {
}

protocol sieve {
  mail_max_userip_connections = 100
}

{%- endif %}

plugin {
  sieve = ~/.dovecot.sieve
  sieve_default = /var/lib/dovecot/sieve/default.sieve
  sieve_dir = ~/sieve
}

userdb {
  args = /etc/dovecot/dovecot-sql.conf
  driver = sql
}

protocol pop3 {
  pop3_uidl_format = %08Xu%08Xv
}
